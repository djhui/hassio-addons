name: Sync Home Assistant Addons

on:
  push:
    branches:
      - main
  schedule:
    - cron: '0 3 * * *'

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false

    steps:
      - uses: actions/checkout@v4

      - name: Setup environment
        run: |
          sudo apt-get update
          sudo apt-get install -y jq unzip wget

      - name: Download addons
        run: |
          declare -A ADDONS=(
            ["official"]="https://github.com/home-assistant/addons/archive/refs/heads/master.zip"
            ["community"]="https://github.com/hassio-addons/repository/archive/refs/heads/master.zip"
            ["alexbelgium"]="https://github.com/alexbelgium/hassio-addons/archive/refs/heads/master.zip"
            ["Poeschl"]="https://github.com/Poeschl-HomeAssistant-Addons/repository/archive/refs/heads/main.zip"
            ["erik73"]="https://github.com/erik73/hassio-addons/archive/refs/heads/master.zip"
            ["einschmidt"]="https://github.com/einschmidt/hassio-addons/archive/refs/heads/main.zip"
            ["FaserF"]="https://github.com/FaserF/hassio-addons/archive/refs/heads/master.zip"
            ["jdeath"]="https://github.com/jdeath/homeassistant-addons/archive/refs/heads/main.zip"
            ["hacs"]="https://github.com/hacs/addons/archive/refs/heads/main.zip"
            ["bluemaes"]="https://github.com/bluemaex/home-assistant-addons/archive/refs/heads/main.zip"
            ["expaso"]="https://github.com/expaso/hassos-addons/archive/refs/heads/main.zip"
            ["blakeblackshear"]="https://github.com/blakeblackshear/frigate-hass-addons/archive/refs/heads/main.zip"
            ["music-assistant"]="https://github.com/music-assistant/home-assistant-addon/archive/refs/heads/main.zip"
            ["esphome"]="https://github.com/esphome/home-assistant-addon/archive/refs/heads/main.zip"
            ["litinoveweedle"]="https://github.com/litinoveweedle/hassio-addons/archive/refs/heads/main.zip"
            ["brenner-tobias"]="https://github.com/brenner-tobias/ha-addons/archive/refs/heads/main.zip"
            ["sanderdw"]="https://github.com/sanderdw/hassio-addons/archive/refs/heads/master.zip"
            ["dianlight"]="https://github.com/dianlight/hassio-addons/archive/refs/heads/master.zip"
            ["hydroqc"]="https://gitlab.com/hydroqc/hydroqc-hass-addons/-/archive/main/hydroqc-hass-addons-main.zip"
            ["hass-broadlink-ac-mqtt"]="https://github.com/Arbuzov/hass-broadlink-ac-mqtt/archive/refs/heads/master.zip"
            ["hugobloem"]="https://github.com/hugobloem/homeassistant-addons/archive/refs/heads/main.zip"
            ["haberda"]="https://github.com/haberda/hassio_addons/archive/refs/heads/master.zip"
            ["AlexxIT"]="https://github.com/AlexxIT/hassio-addons/archive/refs/heads/master.zip"
            ["da-anda"]="https://github.com/da-anda/hass-io-addons/archive/refs/heads/main.zip"
          )

          for addon in "${!ADDONS[@]}"; do
            wget -O "${addon}.zip" "${ADDONS[$addon]}" &
          done
          wait

      - name: Extract addons
        run: |
          mkdir -p addons
          for file in *.zip; do
            unzip -o "$file" -d addons && rm "$file"
          done

      - name: Optimize download links
        run: |
          find addons -type f \( -name "*.yaml" -o -name "*.json" -o -name "Dockerfile" \) -exec sed -i \
            -e 's|ghcr.io|ghcr.nju.edu.cn|g' \
            -e 's|image: homeassistant|image: docker.m.daocloud.io/homeassistant|g' \
            -e 's|docker.io|docker.m.daocloud.io|g' \
            -e 's|lscr.io|docker.m.daocloud.io|g' \
            -e 's|https://github.com|https://gh-proxy.com/github.com|g' \
            -e 's|ADD "https://raw.githubusercontent.com|ADD "https://gh-proxy.com/raw.githubusercontent.com|g' {} +

      - name: Translate descriptions
        run: |
          find ./addons -type f \( -name "config.yaml" -o -name "config.json" \) ! -path "*/.*/*" | while read -r file; do
            {
              if file -b --mime-type "$file" | grep -q "json"; then
                description=$(jq -r '.description' "$file")
                [ "$description" == "null" ] && continue
              else
                if grep -q '^description:\s*|' "$file"; then
                  description=$(awk '/^description:/ {flag=1; next} /^[a-zA-Z0-9]/ {flag=0} flag' "$file")
                else
                  description=$(grep -oP '(?<=^description:\s)(.+)' "$file")
                fi
              fi

              translated_description=$(curl -s --location 'https://open.bigmodel.cn/api/paas/v4/chat/completions' \
                --header "Authorization: Bearer ${{ secrets.ZHIPUAI_KEY }}" \
                --header 'Content-Type: application/json' \
                --data "{
                  \"model\": \"glm-4v-flash\",
                  \"messages\": [
                    {
                      \"role\": \"user\",
                      \"content\": \"只要帮我翻译成中文，不需要其它任何内容：$description\"
                    }
                  ]
                }" | jq -r '.choices[0].message.content')

              if file -b --mime-type "$file" | grep -q "json"; then
                jq --arg description "$translated_description" '.description = $description' "$file" > temp.json && mv temp.json "$file"
              else
                sed -i "s|description:.*|description: \"$translated_description\"|" "$file"
              fi
            } || {
              echo "Error processing $file, skipping..."
              continue
            }
          done

      - name: Clean up files
        run: |
          find addons/ -name ".*" -exec rm -rf {} +
          for ITEM in addons/*/*; do
            if [ -f "$ITEM" ]; then
              rm -f "$ITEM"
            elif [ -d "$ITEM" ]; then
              BASENAME=$(basename "$ITEM")
              TARGET_PATH="./$BASENAME"
              rm -rf "$TARGET_PATH"
              mv -f "$ITEM" "./" || echo "Failed to move directory: $ITEM"
            fi
          done
          rm -rf whisparr

      - name: Sync hass-panel
        run: |
          mkdir -p hass-panel hass-panel-beta
          wget -O hass-panel.zip https://github.com/mrtian2016/hass-panel/archive/refs/heads/main.zip
          unzip -o hass-panel.zip -d hass-panel-temp && rm hass-panel.zip
          mv -f hass-panel-temp/hass-panel-main/hass-panel/* hass-panel/
          mv -f hass-panel-temp/hass-panel-main/hass-panel-beta/* hass-panel-beta/
          rm -rf hass-panel-temp

      - name: Commit and push changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "Sync addons" || echo "No changes to commit"
          git push
